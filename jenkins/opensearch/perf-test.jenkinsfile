lib = library(identifier: "jenkins@20211118", retriever: legacySCM(scm))

pipeline {
    agent none
    environment {
        AWS_ROLE_ARN = "arn:aws:iam::${AWS_ACCOUNT_PUBLIC}:role/opensearch-test"
        AWS_ROLE_SESSION_NAME = "jenkins-test-session"
        BUNDLE_MANIFEST = "bundle-manifest.yml"
    }
    tools {
        jdk "JDK14"
        maven "maven-3.8.2"
    }
    parameters {
        string(
            defaultValue: '',
            name: 'GITHUB_TOKEN',
            description: 'Github token for account access.',
            trim: true
        )
        string(
            defaultValue: '',
            name: 'BUNDLE_MANIFEST_URL',
            description: 'The bundle manifest URL, e.g. https://ci.opensearch.org/ci/dbc/distribution-build-opensearch/1.2.2/98/linux/x64/builds/opensearch/manifest.yml.',
            trim: true
        )
        string(
            defaultValue: '',
            name: 'AGENT_LABEL',
            description: 'The agent label where the tests should be executed, e.g. Jenkins-Agent-al2-x64-c54xlarge-Docker-Host.',
            trim: true
        )
        string(
            defaultValue: '',
            name: 'TEST_WORKLOAD',
            description: 'The agent label where the tests should be executed, e.g. Jenkins-Agent-al2-x64-c54xlarge-Docker-Host.',
            trim: true
        )
        string(
            defaultValue: '',
            name: 'TEST_ITERATIONS',
            description: 'The agent label where the tests should be executed, e.g. Jenkins-Agent-al2-x64-c54xlarge-Docker-Host.',
            trim: true
        )
        string(
            defaultValue: '',
            name: 'WARMUP_ITERATIONS',
            description: 'The agent label where the tests should be executed, e.g. Jenkins-Agent-al2-x64-c54xlarge-Docker-Host.',
            trim: true
        )
    }

    stages {
        stage('perf-test') {
            agent {
                node {
                    label "${AGENT_LABEL}"
                }
            }
            steps {
                script {
                    def bundleManifestObj = downloadBuildManifest(
                        url: BUNDLE_MANIFEST_URL,
                        path: BUNDLE_MANIFEST
                    )
                    String buildId = bundleManifestObj.getArtifactBuildId()
                    env.BUILD_ID = buildId
                    env.SECURITY = bundleManifestObj.components.containsKey("security")
                    echo "BUNDLE_MANIFEST: ${BUNDLE_MANIFEST}"
                    echo "BUILD_ID: ${BUILD_ID}"
                    echo "Security": ${SECURITY}

                    runPerfTestScript(bundleManifest: "${BUNDLE_MANIFEST}",
                        buildId: "${BUILD_ID}")
                }
            }

            post {
                always {
                    script {
                        uploadTestResults(
                                buildManifestFileName: "${BUNDLE_MANIFEST}",
                                jobName: 'perf-test',
                                buildNumber: "${BUILD_ID}"
                        )
                    }
                    cleanWs disableDeferredWipeout: true, deleteDirs: true
                }
            }
        }
    }
    /*
    // Notifications are currently disabled.
    // TODO: Enable notifications post script integration and HOOK creation
    post {
        success {
            node('Jenkins-Agent-al2-x64-m5xlarge') {
                script {
                    def stashed = lib.jenkins.Messages.new(this).get(['perf-test'])
                    publishNotification(
                        icon: ':white_check_mark:',
                        message: 'Integration Performance Successful',
                        extra: stashed,
                        credentialsId: 'PERF_TEST_WEBHOOK',
                    )

                    cleanWs(
                        disableDeferredWipeout: true,
                        deleteDirs: true
                    )
                }
            }
        }
        failure {
            node('Jenkins-Agent-al2-x64-m5xlarge') {
                script  {

                    def stashed = lib.jenkins.Messages.new(this).get(['perf-test'])
                    publishNotification(
                        icon: ':warning:',
                        message: 'Failed Performance Tests',
                        extra: stashed,
                        credentialsId: 'PERF_TEST_WEBHOOK',
                    )

                    cleanWs(
                        disableDeferredWipeout: true,
                        deleteDirs: true
                    )
                }
            }
        }
    }
    */
}
